name: CI/CD

on:
  push:
    branches: [ master ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  pull_request:
    branches: [ master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Use Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18.x'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Build
        run: npm run build
        env:
          NODE_ENV: production
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}

      # Primero limpiar directorios innecesarios
      - name: Clean production directory
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 65002
          script: |
            cd ${{ secrets.DEPLOY_PATH }}
            pm2 stop all || true
            rm -rf public/
            rm -rf src/
            rm -rf logs/
            rm -rf node_modules/

      # Luego desplegar solo los archivos necesarios
      - name: Deploy to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 65002
          source: ".next/,package.json,package-lock.json,server.js,ecosystem.config.js,.env"
          target: ${{ secrets.DEPLOY_PATH }}
          strip_components: 0

      - name: Configure server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 65002
          script: |
            cd ${{ secrets.DEPLOY_PATH }}
            # Crear/actualizar .env
            cat > .env << EOL
            NODE_ENV=production
            PORT=3000
            NEXTAUTH_URL=${{ secrets.NEXTAUTH_URL }}
            NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}
            LOG_LEVEL=info
            EOL
            npm install --production
            npm install -g pm2
            pm2 reload ecosystem.config.js || pm2 start ecosystem.config.js