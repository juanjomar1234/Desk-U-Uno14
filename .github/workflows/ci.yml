name: CI/CD

on:
  push:
    branches: [ master ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'README.md'
  pull_request:
    branches: [ master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Use Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20.x'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Build
        run: npm run build
        env:
          NODE_ENV: production
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}
          
      # Intentar diferentes estrategias de despliegue
      - name: Deploy and configure
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 65002
          script: |
            cd ${{ secrets.DEPLOY_PATH }}
            
            # Limpiar completamente
            pm2 stop all || true
            rm -rf .next
            rm -rf node_modules
            rm -f package-lock.json
            
            # Asegurar permisos del directorio
            chmod -R 755 .
            chown -R ${{ secrets.SSH_USER }}:${{ secrets.SSH_USER }} .
            
            # Instalar dependencias limpias
            npm install --production
            
            # Copiar build y configuraci√≥n
            cp -r /tmp/.next .
            chmod -R 755 .next
            
            # Configurar PM2
            npm install -g pm2
            pm2 startup
            pm2 start ecosystem.config.js --update-env
            pm2 save

      - name: Health check
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 65002
          script: |
            curl -I http://localhost:3000/api/health || true
            pm2 logs --lines 50