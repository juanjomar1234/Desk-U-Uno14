name: CI/CD

on:
  push:
    branches: [ master ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'README.md'
  pull_request:
    branches: [ master ]

jobs:
  check_changes:
    runs-on: ubuntu-latest
    outputs:
      needs_build: ${{ steps.filter.outputs.build }}
      needs_deploy: ${{ steps.filter.outputs.deploy }}
    steps:
      - uses: actions/checkout@v3
      - uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            build:
              - 'src/**'
              - 'public/**'
              - 'package.json'
              - 'next.config.js'
              - 'tsconfig.json'
            deploy:
              - 'src/**'
              - 'server.js'
              - 'ecosystem.config.js'
              - '.env*'
              - 'prisma/**'

  deploy:
    needs: check_changes
    if: |
      github.ref == 'refs/heads/master' && 
      (needs.check_changes.outputs.needs_deploy == 'true' || needs.check_changes.outputs.needs_build == 'true')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Use Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20.x'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Generate Prisma Client
        run: npx prisma generate
        
      - name: Build
        if: needs.check_changes.outputs.needs_build == 'true'
        run: npm run build
        env:
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}

      - name: Clean old .next directory
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 65002
          script: |
            cd ${{ secrets.DEPLOY_PATH }}
            rm -rf .next
            rm -rf .next/.next  # Por si existe la carpeta anidada

      - name: Deploy to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 65002
          source: ".next/,src/,server.js,ecosystem.config.js,package.json,.env"
          target: ${{ secrets.DEPLOY_PATH }}
          strip_components: 0

      - name: Restart application
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 65002
          script: |
            cd ${{ secrets.DEPLOY_PATH }}
            npm install -g pm2
            pm2 reload ecosystem.config.js || pm2 start ecosystem.config.js